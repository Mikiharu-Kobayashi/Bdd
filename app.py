# -*- coding: utf-8 -*-
"""Bdd_app_build.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1SR9a5po4GCVsqx909RC6hcOzwnc_TRMX
"""

import streamlit as st
import google.generativeai as genai
import yfinance as yf
import pandas as pd
import plotly.graph_objects as go
import plotly.express as px
import json
import re
from fpdf import FPDF
import base64
from docx import Document
import io


# --- ãƒšãƒ¼ã‚¸è¨­å®š ---
st.set_page_config(page_title="Quick BDD Analyzer", layout="wide")
st.title("ğŸ“ˆ Quick Business Due Diligence Analyzer")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šAPIã‚­ãƒ¼è¨­å®š ---
with st.sidebar:
    st.header("Settings")
    api_key = st.text_input("Enter Gemini API Key", type="password")
    if api_key:
        genai.configure(api_key=api_key)
        # æœ€æ–°ãƒ¢ãƒ‡ãƒ«ã‚’è‡ªå‹•å–å¾—
        try:
            available_models = [m.name for m in genai.list_models() if 'generateContent' in m.supported_generation_methods]
            selected_model = next((m for m in available_models if 'flash' in m), available_models[0])
            st.success(f"Model Active: {selected_model}")
        except:
            selected_model = "gemini-1.5-flash" # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯

# --- PDFç”Ÿæˆã‚¯ãƒ©ã‚¹ ---
class BDD_PDF(FPDF):
    def header(self):
        self.set_font('Helvetica', 'B', 15)
        self.cell(0, 10, 'Strategic BDD Report', 0, 1, 'C')
        self.ln(10)

# --- Wordç”Ÿæˆç”¨ã®é–¢æ•° ---
def create_word(target, description, report_text):
    doc = Document()
    doc.add_heading('Strategic BDD Report', 0)
    doc.add_heading(f'Target Analysis: {target}', level=1)
    doc.add_paragraph(f"Description: {description}")
    doc.add_heading('Analysis Results', level=1)
    doc.add_paragraph(report_text)
    
    bio = io.BytesIO()
    doc.save(bio)
    return bio.getvalue()        

def create_pdf(target, description, report_text):
    pdf = BDD_PDF()
    pdf.add_page()
    pdf.set_font("Helvetica", size=12)
    pdf.cell(0, 10, f"Target Analysis: {target}", ln=True)
    pdf.ln(5)
    pdf.multi_cell(0, 10, f"Description: {description}")
    pdf.ln(10)
    pdf.multi_cell(0, 10, report_text.encode('latin-1', 'replace').decode('latin-1'))
    return pdf.output()

# --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
target_name = st.text_input("åˆ†æå¯¾è±¡ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šå²é˜œã‚¿ãƒ³ãƒ¡ãƒ³ï¼‰", "")

if st.button("Deep Analysis é–‹å§‹"):
    if not api_key:
        st.error("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")
    elif target_name:
        model = genai.GenerativeModel(selected_model)

        # 1. ç«¶åˆç‰¹å®š
        with st.spinner("ğŸ” AIãŒå¸‚å ´æ§‹é€ ã‚’èª¿æŸ»ä¸­..."):
            comp_prompt = f"ã€Œ{target_name}ã€ã®BDDã‚’è¡Œã„ã¾ã™ã€‚äº‹æ¥­æ¦‚è¦ã¨ä¸Šå ´ç«¶åˆ5ç¤¾ã®éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰(.T)ã‚’JSONå½¢å¼ã®ã¿ã§å‡ºåŠ›ï¼š {{'description': '...', 'competitors': [{{'name': '...', 'ticker': '...'}}]}}"
            res = model.generate_content(comp_prompt)
            data = json.loads(re.search(r'\{.*\}', res.text, re.DOTALL).group())
            st.subheader(f"âœ… å¯¾è±¡ä¼æ¥­ã®å®šç¾©: {target_name}")
            st.info(data['description'])

        # 2. è²¡å‹™ãƒ‡ãƒ¼ã‚¿å–å¾—
        with st.spinner("ğŸ“¡ è²¡å‹™ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºä¸­..."):
            summary_results = []
            for comp in data['competitors']:
                try:
                    stock = yf.Ticker(comp['ticker'])
                    info = stock.info
                    summary_results.append({
                        "ä¼æ¥­å": comp['name'],
                        "æ™‚ä¾¡ç·é¡(å„„)": round(info.get('marketCap', 0) / 1e8, 1),
                        "å£²ä¸Šé«˜(å„„)": round(info.get('totalRevenue', 0) / 1e8, 1),
                        "å–¶æ¥­åˆ©ç›Šç‡(%)": round(info.get('operatingMargins', 0) * 100, 1),
                        "ROE(%)": round(info.get('returnOnEquity', 0) * 100, 1)
                    })
                except: continue
            df = pd.DataFrame(summary_results)
            st.dataframe(df.style.format(precision=1).background_gradient(cmap='Blues'))

        # 3. ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«åŒ–
        fig = px.scatter(df, x="å–¶æ¥­åˆ©ç›Šç‡(%)", y="ROE(%)", size="æ™‚ä¾¡ç·é¡(å„„)", color="ä¼æ¥­å", text="ä¼æ¥­å", template="plotly_white")
        st.plotly_chart(fig, use_container_width=True)

        # 4. BDDãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        with st.spinner("ğŸ“ æˆ¦ç•¥ã‚³ãƒ³ã‚µãƒ«è¦–ç‚¹ã§ã®æè¨€ã‚’ç”Ÿæˆä¸­..."):
            table_str = df.to_markdown()
            report_prompt = f"""
    ã‚ãªãŸã¯ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒ³ã‚µãƒƒã‚¯ã‚¹ï¼ˆIBï¼‰ã®ã‚·ãƒ‹ã‚¢ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
    ä»¥ä¸‹ã®æœ€æ–°è²¡å‹™æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ã€Œ{target_name}ã€ã«é–¢é€£ã™ã‚‹å¸‚å ´ç’°å¢ƒã¨ç«¶åˆä»–ç¤¾ã®åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

    ã€æ¯”è¼ƒå¯¾è±¡ãƒ‡ãƒ¼ã‚¿ã€‘
    {table_str}

    ã€ãƒ¬ãƒãƒ¼ãƒˆæ§‹æˆã€‘
    1. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ãƒ»ã‚µãƒãƒªãƒ¼ï¼š
       æ¥­ç•Œå…¨ä½“ã®ãƒ•ã‚¡ãƒ³ãƒ€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚º/ç«¶åˆå„ªä½æ€§/ {target_name}ã®ç¾çŠ¶ãŠã‚ˆã³å¼·ã¿ã‚’è¸ã¾ãˆãŸæˆé•·æˆ¦ç•¥ã€‚
       1-1.äº‹æ¥­æˆ¦ç•¥
       1-2.äººäº‹æˆ¦ç•¥
       1-3.è²¡å‹™æˆ¦ç•¥
    2. å¸‚å ´æ§‹é€ ã¨æˆé•·ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆMarket Dynamicsï¼‰:
       2-1.æ¥­ç•Œã®KFSï¼ˆé‡è¦æˆåŠŸè¦å› ï¼‰ã¨ã€ç¾åœ¨ãŠã‚ˆã³å°†æ¥ã®ãƒã‚¯ãƒ­ç’°å¢ƒãŒä¸ãˆã‚‹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã€‚
       2-2.è¶³å…ƒæˆé•·ã‚’å¾ŒæŠ¼ã—ã—ã¦ã„ã‚‹ãƒˆãƒ¬ãƒ³ãƒ‰/æˆé•·ç‡ã®é«˜ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆé¡§å®¢å±¤/ä¾¡æ ¼å¸¯ãªã©ï¼‰
       2-3.ãƒãƒ«ãƒãƒ—ãƒ«ï¼ˆPERç­‰ï¼‰ã®è¦³ç‚¹ã‹ã‚‰è¦‹ãŸã€æ¥­ç•Œã®ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ°´æº–ã€‚
    3. ç¨¼ãåŠ›ã¨è³‡æœ¬åŠ¹ç‡ã®å®šé‡çš„æ¯”è¼ƒï¼š
       3-1.å–¶æ¥­åˆ©ç›Šç‡ã¨ROEã®ç›¸é–¢ã‹ã‚‰è¦‹ã‚‹ã€ç«¶åˆå„ç¤¾ã®ã€Œå‚å…¥éšœå£ã€ã¨ã€ŒçµŒå–¶åŠ¹ç‡ã€ã®å·®ã‚’ç”Ÿã‚€æ§‹é€ çš„è¦å› ï¼ˆã‚³ã‚¹ãƒˆæ§‹é€ ã€ã‚¢ã‚»ãƒƒãƒˆãƒ©ã‚¤ãƒˆãƒ¢ãƒ‡ãƒ«ç­‰ï¼‰ã®è§£å‰–
       3-2.ç«¶åˆå„ç¤¾ã®è²¡å‹™æ•°å€¤ã‹ã‚‰é€ã‘ã¦è¦‹ãˆã‚‹ã€Œå„ç¤¾ã®å‹ã¡ãƒ‘ã‚¿ãƒ¼ãƒ³/å¼·ã¿ã€ã®ç‰¹å®š
    4. {target_name}ï¼ˆéä¸Šå ´ï¼‰ã¸ã®æˆ¦ç•¥çš„æè¨€ï¼š
       4-1.ãƒãƒ¼ã‚±ãƒƒãƒˆã¨ç«¶åˆã€  {target_name}ã®å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–ã‚Šã†ã‚‹æˆ¦ç•¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æ´—ã„å‡ºã—
       4-2.æ•°å¹´ã§2-3å€ã®åç›Šã‚’ç›®æŒ‡ã™ç›®ç·šã§ã®ä»®è©•ä¾¡
       ã€€ã€€ç¾çŠ¶ã®ãƒãƒªãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³æ°´æº–ã«åŸºã¥ãã€ã©ã®ã‚ˆã†ãªãƒ¬ãƒãƒ¼ï¼ˆå‡ºåº—åŠ é€Ÿã€å˜ä¾¡ã‚¢ãƒƒãƒ—ç­‰ï¼‰ã‚’å¼•ã‘ã°ä¼æ¥­ä¾¡å€¤ãŒæœ€å¤§åŒ–ã™ã‚‹ã‹ã€‚
    5. äº‹æ¥­æ¨é€²ä¸Šã®è‡´å‘½çš„ãƒªã‚¹ã‚¯ï¼ˆRed Flagsï¼‰:
       BDDã®è¦³ç‚¹ã‹ã‚‰ã€å°†æ¥ã®æˆé•·ã‚’é˜»å®³ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹æ§‹é€ çš„ãƒªã‚¹ã‚¯ã€‚

    â€»ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªè«–èª¿ã§ã€æŠ•è³‡å§”å“¡ä¼šã«æå‡ºã™ã‚‹ãƒ¬ãƒ™ãƒ«ã®å…·ä½“çš„æ•°å€¤ã«åŸºã¥ã„ãŸç¤ºå”†ã‚’å‡ºã—ã¦ãã ã•ã„ã€‚
    """
           with st.spinner("ğŸ“ æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."):
            # ...ï¼ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾ï¼‰...
            report = model.generate_content(report_prompt)
            report_content = report.text
            
            st.markdown("---")
            st.markdown("## ğŸ“˜ Strategic BDD Report")
            st.markdown(report_content)

            # --- å‡ºåŠ›é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ ---
            st.subheader("ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
            col_pdf, col_word = st.columns(2)

            with col_pdf:
                try:
                    pdf_data = create_pdf(target_name, data['description'], report_content)
                    st.download_button(
                        label="ğŸ“„ PDFå½¢å¼ã§ä¿å­˜",
                        data=pdf_data,
                        file_name=f"BDD_Report_{target_name}.pdf",
                        mime="application/pdf"
                    )
                except:
                    st.error("PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ")

            with col_word:
                word_data = create_word(target_name, data['description'], report_content)
                st.download_button(
                    label="ğŸ“ Wordå½¢å¼ã§ä¿å­˜",
                    data=word_data,
                    file_name=f"BDD_Report_{target_name}.docx",
                    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                )
